// prisma/schema.prisma


generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]  
  engineType      = "library"
}

datasource db {
  provider = "postgresql"
}
        
// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id        String   @id @default(cuid())
  supabaseId String  @unique
  email     String   @unique
  name      String?
  username  String?  @unique
  imageUrl  String?
  bio       String?  @db.Text
  
  // Subscription & Billing
  subscriptionTier     SubscriptionTier   @default(FREE)
  subscriptionStatus   SubscriptionStatus @default(ACTIVE)
  stripeCustomerId     String?            @unique
  stripeSubscriptionId String?            @unique
  subscriptionStartDate DateTime?
  subscriptionEndDate   DateTime?
  
  // Credits & Usage
  credits              Int      @default(10)
  creditsUsed          Int      @default(0)
  totalCreditsUsed     Int      @default(0) // All-time total
  lastCreditReset      DateTime @default(now())
  
  // User Preferences
  defaultTone          ContentTone?
  defaultWordCount     Int?     @default(800)
  preferredLanguage    String   @default("en")
  emailNotifications   Boolean  @default(true)
  
  // Brand Voice (Pro/Business feature)
  brandVoice           String?  @db.Text
  customInstructions   String?  @db.Text
  
  // Timestamps
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  lastLoginAt          DateTime?
  
  // Relations
  contents             Content[]
  usageHistory         UsageHistory[]
  apiKeys              ApiKey[]
  teamMemberships      TeamMember[]
  savedTemplates       SavedTemplate[]
  notifications        Notification[]
  exports              Export[]
  
  @@index([supabaseId])
  @@index([email])
}

enum SubscriptionTier {
  FREE
  PRO
  BUSINESS
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
  PAUSED
  EXPIRED
}

// ============================================
// CONTENT
// ============================================

model Content {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Content Details
  title       String
  content     String   @db.Text
  excerpt     String?  @db.Text // First 200 chars for preview
  topic       String?
  tone        ContentTone?
  contentType ContentType @default(BLOG_POST)
  
  // Generation Inputs (for regeneration)
  originalPrompt    String?  @db.Text
  targetAudience    String?
  keywords          String[] // Array of keywords
  generationParams  Json?    // Store all generation parameters
  
  // Metadata
  wordCount        Int
  characterCount   Int?
  readingTime      Int      // in minutes
  language         String   @default("en")
  
  // SEO
  seoScore         Int?     // 0-100
  metaTitle        String?
  metaDescription  String?
  slug             String?
  focusKeyword     String?
  keywordDensity   Float?   // percentage
  readabilityScore Float?   // Flesch reading ease
  
  // Organization
  tags             String[]
  category         String?
  folder           String?
  isFavorite       Boolean  @default(false)
  status           ContentStatus @default(DRAFT)
  
  // Versioning
  version          Int      @default(1)
  parentId         String?  // For version history
  
  // AI Model Info
  aiModel          String?  // e.g., "gpt-4-turbo"
  tokensUsed       Int?
  generationCost   Float?   // in credits
  
  // Publishing
  publishedAt      DateTime?
  scheduledFor     DateTime?
  publishedUrl     String?
  
  // Analytics (future feature)
  views            Int      @default(0)
  shares           Int      @default(0)
  engagement       Float?   // engagement rate
  
  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  lastEditedAt     DateTime @default(now())
  
  // Relations
  exports          Export[]
  versions         ContentVersion[]
  
  @@index([userId])
  @@index([createdAt])
  @@index([status])
  @@index([contentType])
  @@index([isFavorite])
  @@index([publishedAt])

}

enum ContentTone {
  PROFESSIONAL
  CASUAL
  FRIENDLY
  TECHNICAL
  PERSUASIVE
  EDUCATIONAL
  CONVERSATIONAL
  FORMAL
  HUMOROUS
  INSPIRATIONAL
}

enum ContentType {
  BLOG_POST
  SOCIAL_MEDIA
  EMAIL
  PRODUCT_DESCRIPTION
  MARKETING_COPY
  ARTICLE
  PRESS_RELEASE
  LANDING_PAGE
  AD_COPY
  VIDEO_SCRIPT
  CUSTOM
}

enum ContentStatus {
  DRAFT
  IN_REVIEW
  PUBLISHED
  SCHEDULED
  ARCHIVED
}

// ============================================
// CONTENT VERSIONS (Version History)
// ============================================

model ContentVersion {
  id          String   @id @default(cuid())
  contentId   String
  content     Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)
  
  versionNumber Int
  title         String
  contentText   String   @db.Text
  changes       String?  @db.Text // Description of changes
  
  createdAt     DateTime @default(now())
  
  @@index([contentId])
  @@index([versionNumber])
}

// ============================================
// USAGE TRACKING
// ============================================

model UsageHistory {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Usage Details
  action      UsageAction
  tokensUsed  Int?
  creditsUsed Int      @default(1)
  cost        Float?   // Dollar cost (if applicable)
  
  // Request Details
  modelUsed   String?  // e.g., "gpt-4-turbo"
  inputLength Int?     // Characters/tokens in input
  outputLength Int?    // Characters/tokens in output
  
  // Metadata
  metadata    Json?    // Additional data (prompt, settings, etc.)
  success     Boolean  @default(true)
  errorMessage String? @db.Text
  
  // Performance
  responseTime Int?    // milliseconds
  
  // Timestamps
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([createdAt])
  @@index([action])
}

enum UsageAction {
  GENERATE_CONTENT
  REGENERATE_CONTENT
  REGENERATE_SECTION
  ANALYZE_SEO
  EXPORT_CONTENT
  USE_TEMPLATE
  API_REQUEST
}

// ============================================
// TEAM & COLLABORATION (Business tier)
// ============================================

model Team {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?  @db.Text
  logoUrl     String?
  
  // Owner
  ownerId     String
  
  // Subscription (separate from individual users)
  subscriptionTier     SubscriptionTier @default(BUSINESS)
  stripeCustomerId     String?          @unique
  stripeSubscriptionId String?          @unique
  
  // Team Limits
  maxMembers           Int              @default(5)
  currentMembers       Int              @default(1)
  
  // Team Credits (shared pool)
  teamCredits          Int              @default(500)
  creditsUsed          Int              @default(0)
  
  // Settings
  settings             Json?
  brandGuidelines      String?          @db.Text
  
  // Timestamps
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  
  // Relations
  members              TeamMember[]
  invitations          TeamInvitation[]
  
  @@index([slug])
  @@index([ownerId])
}

model TeamMember {
  id        String   @id @default(cuid())
  teamId    String
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  role      TeamRole @default(MEMBER)
  
  // Permissions
  canInvite Boolean  @default(false)
  canDelete Boolean  @default(false)
  canEdit   Boolean  @default(true)
  
  // Status
  isActive  Boolean  @default(true)
  
  // Timestamps
  joinedAt  DateTime @default(now())
  leftAt    DateTime?
  
  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

enum TeamRole {
  OWNER
  ADMIN
  EDITOR
  MEMBER
  VIEWER
}

model TeamInvitation {
  id          String   @id @default(cuid())
  teamId      String
  team        Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  email       String
  role        TeamRole @default(MEMBER)
  invitedBy   String   // userId
  
  token       String   @unique
  status      InvitationStatus @default(PENDING)
  
  expiresAt   DateTime
  acceptedAt  DateTime?
  createdAt   DateTime @default(now())
  
  @@index([teamId])
  @@index([email])
  @@index([token])
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
  CANCELED
}

// ============================================
// API KEYS (Business tier)
// ============================================

model ApiKey {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name        String
  key         String   @unique  // Hashed API key (store hash, not plain)
  keyPreview  String   // First 8 chars for display (e.g., "sk_live_...")
  
  // Permissions
  scopes      String[] // e.g., ["generate", "analyze", "export"]
  
  // Rate Limiting
  rateLimit   Int      @default(100) // requests per hour
  
  // Usage Tracking
  totalRequests Int    @default(0)
  lastUsedAt    DateTime?
  lastUsedIp    String?
  
  // Status
  isActive      Boolean  @default(true)
  
  // Timestamps
  createdAt   DateTime @default(now())
  expiresAt   DateTime?
  revokedAt   DateTime?
  
  @@index([userId])
  @@index([key])
}

// ============================================
// TEMPLATES
// ============================================

model Template {
  id          String   @id @default(cuid())
  
  // Template Info
  name        String
  description String?  @db.Text
  category    TemplateCategory
  subcategory String?
  
  // Template Content
  prompt      String   @db.Text
  systemPrompt String? @db.Text
  exampleOutput String? @db.Text
  
  // Default Settings
  defaultTone       ContentTone?
  defaultWordCount  Int?
  defaultContentType ContentType?
  suggestedKeywords  String[]
  
  // Template Variables (for customization)
  variables   Json?    // e.g., {industry: "string", product: "string"}
  
  // Metadata
  isPublic    Boolean  @default(true)
  isPremium   Boolean  @default(false) // Pro/Business only
  usageCount  Int      @default(0)
  rating      Float?   // Average user rating
  
  // Author (if community templates)
  authorId    String?
  
  // Tags for search
  tags        String[]
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  savedBy     SavedTemplate[]
  
  @@index([category])
  @@index([isPublic])
  @@index([isPremium])

}

enum TemplateCategory {
  BLOG
  SOCIAL_MEDIA
  EMAIL_MARKETING
  ECOMMERCE
  SEO
  ADS
  VIDEO
  BUSINESS
  CREATIVE
  EDUCATION
  OTHER
}

model SavedTemplate {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  templateId String
  template   Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  // Custom settings (override defaults)
  customSettings Json?
  
  timesUsed  Int      @default(0)
  savedAt    DateTime @default(now())
  
  @@unique([userId, templateId])
  @@index([userId])
}

// ============================================
// EXPORTS
// ============================================

model Export {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  contentId   String?
  content     Content? @relation(fields: [contentId], references: [id], onDelete: SetNull)
  
  // Export Details
  format      ExportFormat
  fileName    String
  fileSize    Int?     // bytes
  fileUrl     String?  // If stored in cloud storage
  
  // Settings
  includeMetadata Boolean @default(false)
  
  // Status
  status      ExportStatus @default(PENDING)
  errorMessage String?    @db.Text
  
  // Timestamps
  createdAt   DateTime @default(now())
  completedAt DateTime?
  expiresAt   DateTime? // For temporary download links
  
  @@index([userId])
  @@index([contentId])
  @@index([createdAt])
}

enum ExportFormat {
  MARKDOWN
  PDF
  HTML
  DOCX
  TXT
  JSON
}

enum ExportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Notification Details
  type      NotificationType
  title     String
  message   String   @db.Text
  actionUrl String?  // Link to relevant page
  
  // Metadata
  metadata  Json?
  
  // Status
  isRead    Boolean  @default(false)
  readAt    DateTime?
  
  // Priority
  priority  NotificationPriority @default(NORMAL)
  
  // Timestamps
  createdAt DateTime @default(now())
  expiresAt DateTime?
  
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

enum NotificationType {
  CREDIT_LOW
  CREDIT_EXHAUSTED
  SUBSCRIPTION_EXPIRING
  SUBSCRIPTION_RENEWED
  SUBSCRIPTION_CANCELED
  PAYMENT_FAILED
  TEAM_INVITATION
  CONTENT_PUBLISHED
  NEW_FEATURE
  SYSTEM_UPDATE
  EXPORT_READY
  SECURITY_ALERT
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// ============================================
// ANALYTICS (Future Feature)
// ============================================

model Analytics {
  id        String   @id @default(cuid())
  userId    String
  
  date      DateTime @default(now())
  
  // Daily Metrics
  contentGenerated    Int @default(0)
  creditsUsed         Int @default(0)
  seoAnalysisRun      Int @default(0)
  exportsCreated      Int @default(0)
  
  // Aggregated Data
  totalWordCount      Int @default(0)
  averageSeoScore     Float?
  averageWordCount    Float?
  
  // Popular
  mostUsedTone        String?
  mostUsedContentType String?
  
  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

// ============================================
// FEEDBACK & SUPPORT (Future Feature)
// ============================================

model Feedback {
  id        String   @id @default(cuid())
  userId    String?  // Optional (can be anonymous)
  
  type      FeedbackType
  rating    Int?     // 1-5 stars
  message   String   @db.Text
  
  // Context
  page      String?  // Which page the feedback was from
  userAgent String?
  metadata  Json?
  
  // Status
  status    FeedbackStatus @default(NEW)
  response  String?        @db.Text
  respondedAt DateTime?
  respondedBy String?
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([type])
  @@index([status])
}

enum FeedbackType {
  BUG_REPORT
  FEATURE_REQUEST
  GENERAL_FEEDBACK
  CONTENT_QUALITY
  BILLING_ISSUE
  OTHER
}

enum FeedbackStatus {
  NEW
  IN_REVIEW
  PLANNED
  IN_PROGRESS
  RESOLVED
  DECLINED
}

// ============================================
// SYSTEM SETTINGS (Admin)
// ============================================

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   @db.Text
  type      SettingType
  
  description String? @db.Text
  
  updatedAt DateTime @updatedAt
  updatedBy String?  // Admin user ID
  
  @@index([key])
}

enum SettingType {
  STRING
  NUMBER
  BOOLEAN
  JSON
}

// ============================================
// AUDIT LOG (Security & Compliance)
// ============================================

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  
  action    String   // e.g., "USER_CREATED", "SUBSCRIPTION_UPGRADED"
  entity    String   // e.g., "User", "Content"
  entityId  String?
  
  // Changes
  oldValue  Json?
  newValue  Json?
  
  // Context
  ipAddress String?
  userAgent String?
  metadata  Json?
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}
